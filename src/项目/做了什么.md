# 总体介绍
## 背景
- 有很多运营周期短、页面结构相似的活动页面
- 将页面内常见的组件，比如广告、商品、优惠券、热区等，进行一个抽象和规范化
- 以组件为粒度，进行拖拽搭建。

## 页面结构
- 左侧是组件列表
- 中间是实时预览区域，并提供组件移动、删除、复制等基础功能
- 右侧是属性编辑器
- 点击发布按钮，能生成最终的上线页面

## 核心架构
- 编辑器的搭建能力，即通过拖拽生成一个JSON数据
- 页面发布的能力，即根据JSON数据生成页面
- 场景拓展能力
	- 利用搭建能力和页面发布能力为商家提供更多玩法
	- 实现组件差异化，页面形式多态化
	- 比如，店铺场景、

搭建完成的时候，会生成一个JSON数据。
JSON是由组件对象构成的
组件对象一般有以下几个属性：

- type：组件的类型，用来标识是广告还是商品
- props：组件的可配置属性，比如按钮的某个样式、文案、图片、数据源
- children：组件的子组件

大部分组件都是单层结构，不包含children的。有专门的容器组件，实现组件嵌套。


- 拖拽增删、移动组件，改变的是JSON数据里的组件对象的个数、种类、排列顺序；
- 属性编辑面板，改变的是单个组件对象的props。实现组件的个性化微调。比如广告组件，虽然结构差异不大，但是通过更改传给广告组件的props不同，可以让广告组件千变万化，颜色、图片、文案都有所不同。




# 详细介绍
## 一、编辑器基础功能开发
### 1、属性编辑面板
- 每个组件都有一个属性配置
- 根据组件定义的JSON Schema，属性编辑面板里会渲染相应的输入控件
- 比如要实现一个按钮文案的录入，那么对应的属性控件类型就是input框，提供文案录入的接口
- 如果要实现一个按钮的颜色变化，对应的控件类型就是colorPicker，取色器，提供颜色变换的接口

### 2、可视化楼层管理
### 3、历史记录 
### 4、模板列表页开发
- 使用模板快速派生出页面
- 模板展示、模板收藏、查看大图
- 配置化快速生成

### 5、页面预览功能
- 编辑器内使用挂载渲染
- 预览页内使用后端编译后的页面iframe预览，

## 二、发布流程打通
- 编译采用的是ejs模板。
	- ejs模板是一段html文件，能够接收和渲染来自服务端的数据。
	- ejs模板独立于后端编译服务，作为静态文件托管在cdn上。
	- 编译模板有很多个，跟场景相关，这个后面会介绍。
	- 编译模板表示了一类页面的基本结构，包括渲染逻辑、定制的头部尾部楼层、特殊的上报逻辑、一些特殊的样式文件。
- 服务端负责往编译模板输出2部分重要数据
	- 一、是骨架屏构成的页面源代码。用户打开页面，首先看到的是服务端渲染的骨架屏。
	- 二、可视化编辑器的JSON数据
- 那么真实的组件是怎么渲染出来的呢
	- 编译模板里有一段js脚本，处理JSON数据，解析出依赖的组件
	- 动态构建script去加载组件的代码包，调用reactDom的render方法，把真实的组件渲染到骨架屏的占位dom上



## 三、场景拓展
### 常见问题
- 不同场景有何不同？
	- 组件列表不同：不同的场景，会关联一个组件应用id，不同的组件应用id对应一系列场景所需的组件。一般包括基础组件和场景专属组件
	- 编译模板不同：每个场景对应一个编译模板。	
		- 该场景的所有页面都是用这个编译模板，将一些公共逻辑放到编译模板中。就如上面所说的，编译模板表示了一类页面的基本结构，包括渲染逻辑、定制的头部尾部楼层、特殊的上报逻辑、一些特殊的样式文件。
		- 每个编译模板也会有一个id，使用id与编译服务绑定。这样不同场景编译出来的页面，结构能有所不同。
	- 创建出来的页面类型不同：每个页面都有一个pageType字段
	- 路由不同。场景首页、编辑器的路由都会有所不同

### 1、活动场景 
- 最原始的H5活动页面
- 可投放于京东App

### 2、轻互动
- SNS（抽奖玩法）场景页面赋能活动页
- 在活动页引入一个组件，组件使用iframe打开sns场景的页面 

### 3、店铺场景
- 面向店铺搭建，有店铺相关的业务逻辑，如关注店铺
- 实现页面切图，图片可同步到京东智铺装修

### 4、品牌专区
- 开通了专区的品牌商家有独立的模板、页面、图片资源分区

### 5、自运营场景
- 搭建平台内部常用的落地页，比如场景简介首页

## 四、站点基础功能建设：
- 编译模板管理平台
- 数据看板
- 通用配置管理平台

## 五、组件开发
- 参与过优惠券组件的开发
	- 请求伪造：signature，对称或非对称加密
	- 请求重放：timestamp + nonce
	- 风控 
- 组件代码的书写
- 组件配置文件的自动生成 
- 组件发布与管理




================================================================================



```
- 1、后端打包与资源发布：（待深入）
- 2、骨架屏
	- 每个组件都有对应的骨架屏代码，纯静态，是一段HTML字符串，无需webpack打包处理
	- 每个组件的style都写在组件div里面，容易被整块替换掉
- 3、编译模板渲染真实组件
	- 滚动时，forEach遍历第一层的骨架屏dom。判断骨架屏dom是否到达视口。如果到达视口，则渲染真实组件。
	- 骨架屏dom上会记录了对应的真实组件的类型。根据该类型去创建script并拉取组件代码包。script加载完，调用回调函数:渲染真实的组件到骨架屏这个dom上。
	- 如何判断组件script加载完？
	- 组件报错怎么办？如果楼层中某个子组件script加载失败，那么楼层将无法渲染。但是楼层之间的渲染互不影响。组件外层还会套一个错误边界，真实组件是这个错误边界的子组件。
	- 如何避免组件的重复加载？楼层内可控制组件的重复加载，但是楼层跟楼层之间呢？
```
